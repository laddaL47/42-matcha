# フロントエンド用 Statement of Work (SoW) — Matcha SPA
**用途:** 学校・Peer評価用  
**対象:** フロントエンド（SPA）に限定  
**参照仕様:** 42「Web Matcha」仕様 v5.1（原典の必須要件に準拠し表示/UI要件へ落とし込み）  [oai_citation:0‡matcha.pdf](sediment://file_0000000019f061fab11805d6d74719a3)

---

## 1. 概要（Frontendスコープ）
React を用いたシングルページアプリケーション（SPA）として、登録→プロフィール→探索/検索→相互Like→チャット→通知の**UI/UX**を実装する。  
バックエンドの算出・永続化・通知配信は**API/Socket**に依存し、フロントは**正しい表示・入力検証・状態同期**を責務とする。

---

## 2. 目的
- 参照仕様の**Mandatory機能**を、UI/UXとAPI連携の観点で満たす。  
- モバイル含む主要ブラウザ（Chrome/Firefox）で快適に操作できるSPAを提供。  
- セキュリティ上の基本要件（XSS対策、入力検証、秘密情報未露出）をフロント側で担保。

---

## 3. 前提および採用技術
- **フレームワーク:** React + TypeScript
- **ルーティング:** React Router（SPA用クライアントサイドルーティング）
- **データ取得/キャッシュ:** React Query（サーバ状態の単一ソース）
- **UIライブラリ:** Mantine（固定採用）
- **入力検証:** Zod（スキーマ主導・型安全）
- **リアルタイム:** Socket.IO（新着メッセージ/通知）
- **ビルド:** Vite
- **スタイル:** Mantine + CSS Modules（またはMantineのstyles）
- **国際化:** 必須ではない（英日固定文言で可、将来i18n拡張可能）
- **アクセシビリティ:** 基本的なARIA属性付与、フォーカス管理、コントラスト配慮

### ルーティング設計方針
- **SPA特性を活用:** ページ遷移時のHTML再読み込みなし、状態保持
- **認証統合:** `/authn/` でタブ切り替えによる認証フロー統一
- **動的ルート:** `:username`, `:connectionId` でのパラメータ化
- **認証ガード:** 保護されたルートでの自動リダイレクト
- **ネストルート:** チャット系での階層構造

---

## 4. スコープ（フロントエンドの責務）
### ✅ 含む（UI/UXとAPI/WS連携）
- 登録/ログイン/ログアウト/パスワードリセットの**画面・フォーム**と検証
- メール検証完了画面（トークン検証結果の表示）
- プロフィール編集（性別/性的指向/自己紹介/タグ/写真最大5枚/位置（手動調整含む））
- 推薦一覧の**表示・絞り込み・ソート**（距離/年齢/Fame/タグ）
- 高度検索の**UI**（年齢範囲/距離/タグ/Fame）と結果リストのUI
- プロフィール詳細の表示（オンライン・最終接続・Fame 表示・訪問記録発火のUI連携）
- Like/Unlike、ブロック/通報の操作UIと結果反映
- 相互Like成立時の**チャットUI**（スレッド/メッセージ/既読/入力中）
- **通知UI**（ヘッダー常時バッジ/トースト/未読数、最大10秒内で視認）
- 全画面での**未読/新着インジケータ**表示
- モバイル対応・主要ブラウザ互換

### ❌ 含まない（バックエンド責務）
- 認証トークンの発行/検証ロジック、メール送信
- 位置推定アルゴリズム、Fame Rating の算出式
- SQL/DB、ストレージ管理
- サーバサイドのセキュリティ検証・レート制限

---

## 5. UI構成（主要画面・ルーティング設計）

### 認証系（統合アプローチ）
- `/authn/` **認証メインページ（タブ切り替え）**
  - ログインタブ: Email/Password入力、PWリセットリンク
  - 新規登録タブ: Email/Username/First/Last/Password、Zod検証、規約同意
  - パスワードリセットタブ: Email入力フォーム
- `/authn/verify` メール検証結果表示（成功/失敗）
- `/authn/reset` パスワード再設定（トークン検証）

### プロフィール系
- `/profile/edit` プロフィール編集（基本/タグ/写真/位置）
- `/u/:username` プロフィール閲覧（Like/Unlike、ブロック、通報）

### 探索・検索系
- `/suggestions` 推薦一覧（ソート/フィルターUI付）
- `/search` 高度検索（年齢/距離/Fame/タグ）

### チャット系
- `/chat` チャットメイン（スレッド一覧）
- `/chat/:connectionId` 個別チャット（メッセージ/既読/入力中/無限スクロール）

### 通知・設定系
- `/notifications` 通知一覧（未読管理）
- `/settings` 設定ページ（位置/通知/アカウント）

### ホーム系
- `/` ダッシュボード（認証後のメインページ）

### 共通コンポーネント
- ヘッダー（未読バッジ/新着インジケータ/ログアウト）
- フッター（基本情報・リンク）

---

## 6. 状態管理・通信方針
- **React Query**
  - クエリキー設計: `['me']`, `['profile', username]`, `['suggestions', filters]`, `['search', params]`, `['connections']`, `['messages', connectionId]`, `['notifications', {unread}]`
  - キャッシュ時間/再フェッチ戦略: 画面表示・フォーカス時の再取得、更新系Mutation後の`invalidate`
- **WebSocket (Socket.IO)**
  - 接続: ログイン後に確立、ルーターの上位でサブスクライブ
  - イベント（例）: `notif:like`, `notif:view`, `notif:message`, `notif:mutual`, `notif:unlike`, `chat:message`, `chat:typing`, `chat:read`
  - 再接続: バックオフ、接続中インジケータ
  - React Query への橋渡し: 受信時 `queryClient.setQueryData` / `invalidateQueries`

---

## 7. 入力検証（Zod）
- 各フォームに**Zodスキーマ**を定義し、`zodResolver`連携（React Hook Form想定 or 自前バインド）
- 例: パスワード強度（長さ/文字種/辞書的英単語NG）、プロフィール（自己紹介最大長、タグ形式、画像枚数<=5）
- 画像アップロード: クライアント側で拡張子/MIME/サイズの**事前検証**と枚数制限、EXIF除去はサーバ依存だがUIで注意喚起

---

## 8. アクセシビリティ/UX基準
- フォームはラベル/エラーメッセージ関連付け
- キーボード操作可、フォーカスリング可視
- 色コントラスト比をMantineテーマで担保
- ローディング/送信中/エラー/成功のフィードバック
- 画像の代替テキスト（プロフィール/サムネイル）

---

## 9. セキュリティ・フロント観点
- XSS: `dangerouslySetInnerHTML`禁止、ユーザー生成テキストは必ずエスケープ表示
- Secrets: `.env`はビルド時公開されうるため、**秘密情報は埋めない**（公開可なBASE_URL等のみ）
- 認証: Cookieベースを想定し、`credentials: 'include'`を徹底（CORSはサーバ設定依存）
- CSRF: Cookie運用時はサーバ対策に追随し、必要ヘッダ付与UI

---

## 10. パフォーマンス指標（目安）
- 初回インタラクティブ < 3s（開発環境差し引き）
- チャット・通知の新着UI反映 ≤ 10s（仕様準拠）
- 画像は遅延読み込み（IntersectionObserver）
- リストは仮想化検討（カード大量時）

---

## 11. Mandatory機能チェックリスト（フロントエンド）

### ルーティング基盤
- [ ] React Router導入・設定
- [ ] 認証ガード実装（保護されたルート）
- [ ] 動的ルート対応（`:username`, `:connectionId`）
- [ ] ネストルート実装（チャット系）
- [ ] 404ページ・エラーハンドリング

### 認証/登録（統合アプローチ）
- [ ] `/authn/` タブ切り替え認証ページ
- [ ] ログインタブ（Email/Password入力、PWリセットリンク）
- [ ] 新規登録タブ（Email/Username/First/Last/PW）Zod検証
- [ ] 一般英単語PWの拒否（辞書チェック or 事前定義NG語）
- [ ] パスワードリセットタブ（Email入力）
- [ ] `/authn/verify` メール検証結果画面（成功/失敗の分岐表示）
- [ ] `/authn/reset` パスワード再設定（トークン検証）

### プロフィール
- [ ] 基本情報（性別/指向/自己紹介/誕生日）
- [ ] タグ（再利用可能UI: タグ候補検索+追加/削除）
- [ ] 画像（最大5枚・メイン指定・プレビュー・順序変更）
- [ ] 位置（許諾不可時は手動調整UI）
- [ ] 「見られた履歴」「Likeされた履歴」の表示

### 推薦/検索/閲覧
- [ ] 推薦一覧（距離>共通タグ>Fameを内部スコア表示で示唆）
- [ ] ソート（年齢/距離/Fame/タグ共有）
- [ ] フィルター（スライダー/トグル）
- [ ] 高度検索フォーム（年齢範囲/距離/タグ/Fame）
- [ ] プロフィール詳細（メール/PW除外、Fame/オンライン/最終接続）
- [ ] Like/Unlike、ブロック、通報の操作UI

### チャット（ルーティング対応）
- [ ] `/chat` スレッド一覧（相互Like成立ユーザーのみ）
- [ ] `/chat/:connectionId` 個別チャットルーム
- [ ] メッセージ一覧（無限スクロール/最新へスクロール）
- [ ] 作成/送信/入力中表示/既読表示
- [ ] WS切断・再接続ハンドリング
- [ ] チャット間のナビゲーション

### 通知
- [ ] ヘッダーバッジ（未読数）
- [ ] 新着トースト（like/view/message/mutual/unlike）
- [ ] 通知一覧/既読化
- [ ] 最大10秒以内で視認できるUI更新

---

## 12. 品質要件チェックリスト（フロント）
- [ ] 主要画面で**警告/エラーコンソール出力ゼロ**
- [ ] Chrome/Firefox 最新版で表示崩れ無し（モバイル含む）
- [ ] すべてのフォームが**Zod検証**を通過しないと送信不可
- [ ] ユーザー生成テキストは**エスケープ表示**
- [ ] 環境変数の**秘密値をバンドルしない**
- [ ] 通知/チャットのUI反映が**≤10秒**
- [ ] 画像は**枚数/サイズ上限**をUIで強制
- [ ] 未読/新着を**全ページ**で可視（ヘッダー/バッジ）

---

## 13. 受け入れ基準（Peer評価時）

### ルーティング要件
- **SPA特性:** ページ遷移時にHTML再読み込みなし、状態保持
- **認証フロー:** `/authn/` タブ切り替えでスムーズな認証体験
- **動的ルート:** `:username`, `:connectionId` でのパラメータ化が正常動作
- **認証ガード:** 未認証時の自動リダイレクト（`/authn/`）
- **ネストルート:** チャット系での階層ナビゲーション

### 機能要件
- ルーティングが仕様どおりに遷移し、**全フローがUIで完結**  
  （登録→メール検証表示→編集→推薦/検索→相互Like→チャット→通知閲覧）
- 各操作で**即時のUI反映**（React Queryのキャッシュ更新 or invalidate）
- Socket.IO 経由の新着メッセージ/通知が**視覚的に確認**できる
- エラー時の**ユーザ向け説明**が表示（トースト/inlineエラー）
- 主要機能で**アクセシビリティ配慮**（フォーカス/ラベル/コントラスト）

---

## 14. 成果物
- フロントエンドSPA一式（`/frontend` もしくはルート直下）
- **ルーティング実装:** React Router設定・認証ガード・動的ルート
- **認証統合:** `/authn/` タブ切り替え認証ページ
- **画面一覧/ルーティング定義:** 全ページのルートマッピング
- React Query のクエリキー一覧とキャッシュポリシー
- Zod スキーマ定義（フォーム別）
- Socket.IO クライアント実装（イベント購読/再接続）
- ビルド/起動手順（README 記載）

---

## 15. API/WS 依存インターフェイス（フロント観点の合意事項）
> バックエンドの詳細は変動しうるため、ここでは**フロントが期待する最小契約**を明記。  
> 実装時は OpenAPI 等で詰め、差異はアダプタ層で吸収。

- REST（例）
  - `POST /auth/register|login|logout|forgot|reset`  
  - `GET/PATCH /me`, `GET /users/:username`  
  - `GET /suggestions`, `GET /search`  
  - `POST/DELETE /users/:id/like|block`, `POST /users/:id/report`  
  - `GET /connections`, `GET /connections/:id/messages`
  - `GET /notifications?unread=true`
- WS（Socket.IO イベント例）
  - `notif:*`（like/view/message/mutual/unlike）
  - `chat:message`, `chat:typing`, `chat:read`

---

## 16. 付記
- 本SoWは**フロントエンド領域に限定**し、原典の必須要件をUI/UXへマッピングしたもの。  
- バックエンドやDBの責務は別ドキュメントとする（必要ならAPI契約書を分離）。
